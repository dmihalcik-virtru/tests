import tokenRequester from 'keycloak-request-token';
import {expect, test} from "@playwright/test";
import {constants} from "http2";
import * as fs from "fs";
import * as readline from "readline";

// @ts-ignore
const {authority, entitlements, clientId, realm} = JSON.parse(process.env.SERVER_DATA);
const {grantor} = JSON.parse(process.env.TEST_DATA);

const baseUrl = authority.substring(0, authority.length - 1);
const settings = {
    username: grantor.username,
    password: grantor.password,
    grant_type: 'password',
    client_id: clientId,
    realmName: realm
};

// Request context is reused by all tests in the file.
let apiContext;
// test data
let genericSqlInjectionPayload: [string];


test.beforeAll(async ({playwright}) => {
    // read test data
    const rl = readline.createInterface({
        input: fs.createReadStream('resources/generic-sql-injection-payload.txt'),
        output: process.stdout,
        terminal: false
    });
    rl.on('line', (line) => {
        if (line.trim()) {
            if (!genericSqlInjectionPayload) {
                genericSqlInjectionPayload = [line.trim()];
            }
            genericSqlInjectionPayload.push(line.trim());
        }
    });
    // login
    const token = await tokenRequester(baseUrl, settings);
    apiContext = await playwright.request.newContext({
        extraHTTPHeaders: {
            'Authorization': `Bearer ${token}`,
        },
    });
})

test.afterAll(async ({}) => {
    // Dispose all responses.
    await apiContext.dispose();
});

test('entitlements header test', async ({request}) => {
    const response = await apiContext.get(`${entitlements}/entitlements`, {});
    expect(response.status()).toBe(constants.HTTP_STATUS_OK);
    const headers = response.headers();
    // console.log(headers);
    expect(headers['x-content-type-options']).toBeTruthy();
    await expect(headers['x-content-type-options']).toContain('nosniff');
});

test('entitlements attribute value sql injection test', async ({request}) => {
    let testEntityId = 'aa3fa152-b574-4869-9086-d5f97bd1ad97'; // test-entity-nonperson-00
    const testEntitlements = [`https://a/attr/a/value/a`];
    for (let payload of genericSqlInjectionPayload) {
        testEntitlements.push(`https://a/attr/a/value/${payload}`);
    }
    const response = await apiContext.post(`${entitlements}/entitlements/${testEntityId}`, {
        data: testEntitlements
    });
    expect(response.status()).not.toBe(constants.HTTP_STATUS_INTERNAL_SERVER_ERROR);
    console.log(response.status());
    console.log((await response.body()).toString());
});

test('entitlements attribute name sql injection test', async ({request}) => {
    let testEntityId = 'aa3fa152-b574-4869-9086-d5f97bd1ad97'; // test-entity-nonperson-00
    const testEntitlements = [`https://a/attr/a/value/a`];
    for (let payload of genericSqlInjectionPayload) {
        testEntitlements.push(`https://a/attr/${payload}/value/a`);
    }
    const response = await apiContext.post(`${entitlements}/entitlements/${testEntityId}`, {
        data: testEntitlements
    });
    expect(response.status()).not.toBe(constants.HTTP_STATUS_INTERNAL_SERVER_ERROR);
    console.log(response.status());
    console.log((await response.body()).toString());
});

test('entitlements attribute authority sql injection test', async ({request}) => {
    let testEntityId = 'aa3fa152-b574-4869-9086-d5f97bd1ad97'; // test-entity-nonperson-00
    const testEntitlements = [`https://a/attr/a/value/a`];
    for (let payload of genericSqlInjectionPayload) {
        testEntitlements.push(`https://${payload}/attr/a/value/a`);
    }
    const response = await apiContext.post(`${entitlements}/entitlements/${testEntityId}`, {
        data: testEntitlements
    });
    expect(response.status()).not.toBe(constants.HTTP_STATUS_INTERNAL_SERVER_ERROR);
    console.log(response.status());
    console.log((await response.body()).toString());
});

test('entitlements entityId sql injection test', async ({request}) => {
    const testEntitlements = [`https://a/attr/a/value/a`];
    for (let payload of genericSqlInjectionPayload) {
        const encodedPayload = encodeURI(payload);
        const response = await apiContext.post(`${entitlements}/entitlements/${encodedPayload}`, {
            data: testEntitlements
        });
        expect(response.status()).not.toBe(constants.HTTP_STATUS_INTERNAL_SERVER_ERROR);
        console.log(response.status());
        console.log((await response.body()).toString());
    }
});
